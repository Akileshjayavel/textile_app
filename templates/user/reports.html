{% extends "base.html" %}
{% block content %}

<!-- HEADER -->
<div class="d-flex justify-content-between align-items-center mb-4 icon-link-hover">
  <div>
    <h4 class="fw-bold text-dark mb-1">Sales Ledger</h4>
    <p class="text-sm text-muted mb-0">Track daily sales, payments, and performance</p>
  </div>
  <div class="d-flex gap-2 no-print">
    <button class="btn btn-primary btn-sm" onclick="window.print()">
      <i class="bi bi-printer me-1"></i> Print Report
    </button>
  </div>
</div>

<!-- FILTERS -->
<div class="card mb-4 border-0 shadow-sm no-print">
  <div class="card-body p-3">
    <form method="post" class="row align-items-end g-3">
      <div class="col-md-4">
        <label class="form-label text-xs uppercase text-muted fw-bold">Date Range Selector</label>
        <div class="input-group">
          <span class="input-group-text bg-white border-end-0 text-primary">
            <i class="bi bi-calendar-range"></i>
          </span>
          <input type="text" id="dateRange" name="date_range" class="form-control border-start-0 ps-0"
            placeholder="Select dates..." value="{{ selected_range or '' }}" readonly>
        </div>
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">
          Apply Filter
        </button>
      </div>
      {% if selected_range %}
      <div class="col-md-6 text-end">
        <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill fw-normal">
          Comparing: <strong>{{ selected_range }}</strong>
        </span>
      </div>
      {% endif %}
    </form>
  </div>
</div>

<!-- KPI CARDS -->
<div class="row g-3 mb-4 no-print">
  <!-- Total Bills -->
  <div class="col-md-2">
    <div class="card border-0 shadow-sm h-100 text-center py-3">
      <div class="text-xs text-muted font-bold uppercase mb-1">Bills</div>
      <div class="fs-4 fw-bold text-dark">{{ total_bills }}</div>
    </div>
  </div>

  <!-- Sales -->
  <div class="col-md-2">
    <div class="card border-0 shadow-sm h-100 text-center py-3">
      <div class="text-xs text-muted font-bold uppercase mb-1">Sales</div>
      <div class="fs-4 fw-bold text-primary">₹{{ total_sales }}</div>
    </div>
  </div>

  <!-- Cash -->
  <div class="col-md-2">
    <div class="card border-0 shadow-sm h-100 text-center py-3">
      <div class="text-xs text-muted font-bold uppercase mb-1">Cash</div>
      <div class="fs-5 fw-bold text-success">₹{{ cash_total }}</div>
    </div>
  </div>

  <!-- UPI -->
  <div class="col-md-2">
    <div class="card border-0 shadow-sm h-100 text-center py-3">
      <div class="text-xs text-muted font-bold uppercase mb-1">UPI</div>
      <div class="fs-5 fw-bold text-info">₹{{ upi_total }}</div>
    </div>
  </div>

  <!-- Pending -->
  <div class="col-md-2">
    <div class="card border-0 shadow-sm h-100 text-center py-3">
      <div class="text-xs text-muted font-bold uppercase mb-1">Pending</div>
      <div class="fs-5 fw-bold text-warning">₹{{ pending_total }}</div>
    </div>
  </div>

  <!-- Recovered -->
  <div class="col-md-2">
    <div class="card border-0 shadow-sm h-100 text-center py-3">
      <div class="text-xs text-muted font-bold uppercase mb-1">Collected</div>
      <div class="fs-5 fw-bold text-dark">₹{{ old_pending_collected }}</div>
    </div>
  </div>
</div>

<!-- DATA TABLE -->
<div class="glass-premium glass-card card border-0 shadow-lg no-print">
  <div class="card-header bg-transparent border-bottom px-4 py-3">
    <h6 class="mb-0 fw-bold text-primary">Transaction History</h6>
  </div>
  <div class="table-responsive">
    {% if rows and rows|length > 0 %}
    <table class="table table-hover align-middle mb-0">
      <thead>
        <tr>
          <th class="ps-4">Bill No</th>
          <th>Date & Time</th>
          <th class="text-end">Cash</th>
          <th class="text-end pe-4">UPI</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td class="ps-4 fw-medium">
            <a href="{{ url_for('view_bill', bill_no=r.bill_no, source='reports') }}"
              class="text-decoration-none font-monospace text-primary">
              {{ r.bill_no }}
            </a>
          </td>
          <td class="text-muted text-sm">{{ r.created_at }}</td>
          <td class="text-end font-monospace text-dark">
            {% if r.cash_amount > 0 %}₹{{ r.cash_amount }}{% else %}-{% endif %}
          </td>
          <td class="text-end font-monospace text-dark pe-4">
            {% if r.paytm_amount > 0 %}₹{{ r.paytm_amount }}{% else %}-{% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="text-center py-5">
      <div class="text-muted mb-2"><i class="bi bi-calendar-x display-4"></i></div>
      <p class="text-muted">No transactions found for this period.</p>
    </div>
    {% endif %}
  </div>
</div>

<!-- PRINT AREA (Professional Letterhead) -->
<div id="print-area">
  <!-- Header -->
  <div style="border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 25px;">
    <div style="display: flex; align-items: center;">
      <!-- Logo Section -->
      <div style="width: 80px; margin-right: 20px;">
        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo" style="width: 100%; height: auto;">
      </div>

      <!-- Shop Details -->
      <div style="flex-grow: 1;">
        <h1 style="font-size: 26px; font-weight: 800; margin: 0; text-transform: uppercase; color: #000;">Iraimagal
          Textile</h1>
        <p style="font-size: 13px; margin: 5px 0 0 0; color: #333;">#1 Mumbai Bhavan, Avatti Kootroad, Kallur - 606108
        </p>
        <div style="display: flex; gap: 20px; margin-top: 5px; font-size: 13px; font-weight: 500;">
          <span>Phone: +91 98406 48788</span>
          <span>GSTIN: 33ABCDE1234Z5X</span>
        </div>
      </div>

      <!-- Report Meta -->
      <div style="text-align: right; min-width: 150px;">
        <div style="background: #f8f9fa; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
          <p style="font-size: 11px; margin: 0; color: #666; text-transform: uppercase; letter-spacing: 0.5px;">Report
            Date</p>
          <p style="font-size: 14px; margin: 2px 0 0 0; font-weight: bold;">{{ selected_range if selected_range else
            'Today' }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Title -->
  <div style="text-align: center; margin-bottom: 25px;">
    <h3 style="font-size: 20px; font-weight: 700; text-transform: uppercase; margin: 0; letter-spacing: 1px;">Sales
      Summary Report</h3>
    <div style="width: 60px; height: 3px; background: #0d6efd; margin: 8px auto 0;"></div>
  </div>

  <!-- Summary Table -->
  <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px; font-size: 14px;">
    <tbody>
      <tr style="background: #f8f9fa;">
        <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600; width: 60%;">Total Bills Generated</td>
        <td
          style="padding: 12px; border: 1px solid #dee2e6; text-align: right; font-family: monospace; font-size: 16px; font-weight: 600;">
          {{ total_bills }}</td>
      </tr>
      <tr>
        <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">Total Sales Amount</td>
        <td
          style="padding: 12px; border: 1px solid #dee2e6; text-align: right; font-family: monospace; font-size: 16px; font-weight: 600;">
          ₹ {{ total_sales }}</td>
      </tr>
      <tr style="background: #f8f9fa;">
        <td style="padding: 12px; border: 1px solid #dee2e6;">Cash Received</td>
        <td
          style="padding: 12px; border: 1px solid #dee2e6; text-align: right; font-family: monospace; font-size: 15px;">
          ₹ {{ cash_total }}</td>
      </tr>
      <tr>
        <td style="padding: 12px; border: 1px solid #dee2e6;">UPI / Online Received</td>
        <td
          style="padding: 12px; border: 1px solid #dee2e6; text-align: right; font-family: monospace; font-size: 15px;">
          ₹ {{ upi_total }}</td>
      </tr>
      <tr style="background: #fff3cd;">
        <td style="padding: 12px; border: 1px solid #dee2e6; font-weight: bold; color: #856404;">Pending / Credit Sales
        </td>
        <td
          style="padding: 12px; border: 1px solid #dee2e6; text-align: right; font-family: monospace; font-weight: bold; color: #856404; font-size: 15px;">
          ₹ {{ pending_total }}</td>
      </tr>
    </tbody>
  </table>

  <!-- Footer -->
  <div style="margin-top: 60px; display: flex; justify-content: space-between; align-items: flex-end;">
    <div style="text-align: left; font-size: 11px; color: #666;">
      <p style="margin: 0;">Generated by System User</p>
      <p style="margin: 2px 0 0 0;">{{ now }}</p>
    </div>
    <div style="text-align: center; width: 200px;">
      <div style="border-top: 1px solid #000; padding-top: 8px; font-size: 13px; font-weight: 600;">Authorized Signature
      </div>
    </div>
  </div>
</div>

<style>
  /* Print Styles */
  #print-area {
    display: none;
  }

  @media print {
    body * {
      visibility: hidden;
    }

    #print-area,
    #print-area * {
      visibility: visible;
    }

    #print-area {
      display: block;
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      padding: 40px;
      font-family: 'Inter', sans-serif;
      color: #000;
      background: #fff;
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const picker = flatpickr("#dateRange", {
      mode: "range",
      dateFormat: "Y-m-d",
      maxDate: "today",
      altInput: true,
      altFormat: "F j, Y",
    });
  });
</script>

{% endblock %}