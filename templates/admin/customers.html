{% extends "base.html" %}

{% block content %}

<!-- ================= HEADER ================= -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="fw-semibold mb-0">Admin Customers</h3>

    <!-- ✅ DOWNLOAD BUTTONS -->
    <div>
        <a href="{{ url_for('admin_customers.download_all_customers') }}"
           class="btn btn-sm btn-outline-success me-1">
            Download All
        </a>

        <a href="{{ url_for('admin_customers.download_new_customers') }}"
           class="btn btn-sm btn-success">
            Download New
        </a>
    </div>
</div>

<!-- ================= SEARCH + COUNT ================= -->
<div class="row mb-3 align-items-center">
    <div class="col-md-4 col-lg-3">
        <input type="text"
               id="customerSearch"
               class="form-control form-control-sm"
               placeholder="Search customer...">
    </div>

    <div class="col-auto">
        <button class="btn btn-sm btn-outline-secondary" id="clearSearchBtn">
            Clear
        </button>
    </div>

    <div class="col text-end">
        <span class="badge bg-secondary">
            Total Customers: {{ customers|length }}
        </span>
    </div>
</div>

<!-- ================= CUSTOMER TABLE ================= -->
<div class="card shadow-sm">
    <div class="table-responsive customer-table-wrapper">
        <table class="table table-bordered table-hover mb-0 align-middle">
            <thead class="table-light">
                <tr>
                    <th style="width:5%">#</th>
                    <th style="width:22%">Name</th>
                    <th style="width:18%">Mobile</th>
                    <th>Address</th>
                    <th style="width:18%">Created At</th>
                    <th style="width:15%" class="text-center">Action</th>
                </tr>
            </thead>

            <tbody id="customerTableBody">
                {% for c in customers %}
                <tr class="customer-row">
                    <td class="row-index"></td>

                    <!-- ✅ CLICKABLE NAME → SUMMARY PAGE -->
                    <td class="fw-semibold">
                        <a href="{{ url_for('admin_customers.customer_summary_page', customer_id=c.id) }}"
                           class="text-decoration-none text-primary">
                            {{ c.name }}
                        </a>
                    </td>

                    <td>
                        <a href="tel:{{ c.mobile }}" class="text-decoration-none">
                            {{ c.mobile }}
                        </a>
                    </td>

                    <td>{{ c.address if c.address else "-" }}</td>
                    <td>{{ c.created_at }}</td>

                    <td class="text-center">
                        <a href="{{ url_for('admin_customers.edit_customer', customer_id=c.id) }}"
                           class="btn btn-sm btn-primary me-1">
                            Edit
                        </a>

                        <!-- ✅ DELETE (SWEETALERT) -->
                        <form method="post"
                              action="{{ url_for('admin_customers.delete_customer', customer_id=c.id) }}"
                              id="delete-form-{{ c.id }}"
                              style="display:inline;">
                            <button type="button"
                                    class="btn btn-sm btn-danger delete-btn"
                                    data-form-id="delete-form-{{ c.id }}"
                                    data-name="{{ c.name }}">
                                Delete
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- ================= PAGINATION INFO ================= -->
<div class="d-flex justify-content-between align-items-center mt-2">
    <small id="paginationInfo" class="text-muted"></small>

    <div>
        <button class="btn btn-sm btn-outline-secondary me-1" id="prevPage">Prev</button>
        <button class="btn btn-sm btn-outline-secondary" id="nextPage">Next</button>
    </div>
</div>

{% endblock %}

{% block scripts %}
<style>
.customer-table-wrapper {
    max-height: 70vh;
    overflow-y: auto;
}
</style>

<!-- ✅ SWEETALERT2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
/* ================= DELETE CONFIRMATION ================= */
document.addEventListener("click", function (e) {
    if (e.target.classList.contains("delete-btn")) {

        const customerName = e.target.dataset.name;
        const formId = e.target.dataset.formId;

        Swal.fire({
            title: "Delete Customer?",
            html: `
                <p class="mb-1">Are you sure you want to delete</p>
                <strong class="text-danger">${customerName}</strong>
                <p class="mt-2 text-muted">This action cannot be undone.</p>
            `,
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Yes, Delete",
            cancelButtonText: "Cancel",
            confirmButtonColor: "#d33",
            cancelButtonColor: "#6c757d",
            focusCancel: true
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById(formId).submit();
            }
        });
    }
});

/* ================= SEARCH + PAGINATION ================= */
const rowsPerPage = 10;
let currentPage = 1;

const rows = Array.from(document.querySelectorAll(".customer-row"));
const searchInput = document.getElementById("customerSearch");
const paginationInfo = document.getElementById("paginationInfo");

function renderTable() {
    const q = searchInput.value.toLowerCase();
    const filtered = rows.filter(r =>
        r.innerText.toLowerCase().includes(q)
    );

    const totalPages = Math.ceil(filtered.length / rowsPerPage);
    currentPage = Math.min(currentPage, totalPages || 1);

    rows.forEach(r => r.style.display = "none");

    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;

    filtered.slice(start, end).forEach((row, i) => {
        row.style.display = "";
        row.querySelector(".row-index").innerText = start + i + 1;
    });

    paginationInfo.innerText =
        `Showing ${filtered.length ? start + 1 : 0}–${Math.min(end, filtered.length)} of ${filtered.length}`;
}

document.getElementById("clearSearchBtn").onclick = () => {
    searchInput.value = "";
    currentPage = 1;
    renderTable();
};

searchInput.oninput = () => {
    currentPage = 1;
    renderTable();
};

document.getElementById("prevPage").onclick = () => {
    if (currentPage > 1) {
        currentPage--;
        renderTable();
    }
};

document.getElementById("nextPage").onclick = () => {
    currentPage++;
    renderTable();
};

renderTable();
</script>
{% endblock %}
